trigger:
  branches:
    include:
      - main
    exclude:
      - feature/*
pool:
 name: 'Default'

variables:
  - group: 'acr-settings'  # Load variables from the variable group
  - name: imageTag
    value: $(Build.BuildId)  # Override if needed

stages:
- stage: Build
  displayName: 'Build and Push Docker Image to ACR'
  jobs:
  - job: BuildPush
    displayName: 'Build and Push Image'
    steps:
    - task: ACRTask@0
      inputs:
        azureSubscription: 'svc-connection1'
        azureContainerRegistry: 'azurecr13'
        containerRepository: '$( containerRepository)'
        contextType: 'Git'
        githubConnection: 'avulakishore11'
        repositoryName: 'avulakishore11/SpringBoot-RunnersExample'
        branch: 'master'
        dockerfileOrTaskFile: 'dockerfile'
   # - task: Docker@2
    #  displayName: 'Build and Push Image to ACR'
     # inputs:
      ## repository: '$(containerRepository)/$(imageName)' # just use either imagename or containerRepository
        #command: 'buildAndPush'
      #  Dockerfile: '**/dockerfile'
       # tags: |
        #  $(imageTag)
- stage: Deploy
  dependsOn: Build
  displayName: 'deploy to AKS'
  jobs:
    - job: 
      displayName: deploy to AKS
      steps:
        - task: KubernetesManifest@1
          inputs:
            action: 'deploy'
            connectionType: 'azureResourceManager'
            azureSubscriptionConnection: '$(azureSubscription)' # sevice connection
            azureResourceGroup: 'dev-rg'
            kubernetesCluster: '$(AKS-cluster-name)'
            manifests: 'deployment.yml'
